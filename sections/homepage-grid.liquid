{%- liquid
  assign selected_collection = section.settings.collection | default: collections['all']
  if request.page_type == 'collection'
    assign collection = collection
  else
    assign collection = selected_collection
  endif
-%}

<div class="homepage-grid-section relative border-b border-vinyl-blue" id="homepage-grid-{{ section.id }}">
  
  <!-- Shared border container -->
  <div class="border-l border-vinyl-blue">
    
    <!-- Backdrop Overlay -->
    <div 
      class="filter-backdrop fixed inset-0 bg-black/50 transition-opacity duration-300 z-40 hidden pointer-events-none opacity-0 invisible"
      data-filter-backdrop
      aria-hidden="true">
    </div>
    
    <!-- Filter Bar (sticky at top of section) -->
    <div class="sticky top-0 z-[45] bg-vinyl-blue border-r border-b border-vinyl-blue py-4 px-4 sm:px-8 flex justify-between items-center" data-filter-bar>
      <!-- Filters Button (Left) -->
      <button
        type="button"
        class="filter-toggle flex items-center gap-2 font-mono text-xs uppercase font-bold text-white hover:text-gray-200 transition-colors bg-transparent border-none cursor-pointer"
        data-filter-toggle-isolated
        aria-expanded="false"
        aria-controls="filter-panel-{{ section.id }}">
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" class="transition-transform pointer-events-none" data-filter-icon>
          <path d="M3 6l3 3 3-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
        <span class="pointer-events-none">FILTERS</span>
      </button>

      <!-- Sort Dropdown (Right) -->
      <div class="sort-dropdown relative" data-sort-dropdown>
        <button 
          type="button"
          class="sort-toggle flex items-center gap-2 font-mono text-xs uppercase font-bold text-white hover:text-gray-200 transition-colors bg-transparent border-none cursor-pointer"
          data-sort-toggle
          aria-expanded="false"
          aria-controls="sort-menu-{{ section.id }}">
          SORT BY
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none" class="transition-transform" data-sort-icon>
            <path d="M3 5l3 3 3-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </button>
        
        <!-- Sort Menu -->
        <div 
          id="sort-menu-{{ section.id }}"
          class="sort-menu absolute top-full right-0 mt-2 bg-white border border-gray-300 min-w-[220px] opacity-0 invisible translate-y-[-10px] transition-all duration-200 shadow-lg z-50"
          data-sort-menu
          role="menu">
          <button type="button" class="sort-option block w-full text-left px-4 py-3 font-mono text-xs uppercase text-vinyl-blue hover:bg-gray-100 transition-colors border-none cursor-pointer bg-transparent" data-sort="featured" role="menuitem">Featured</button>
          <button type="button" class="sort-option block w-full text-left px-4 py-3 font-mono text-xs uppercase text-gray-700 hover:bg-gray-100 transition-colors border-none cursor-pointer bg-transparent" data-sort="best-selling" role="menuitem">Best selling</button>
          <button type="button" class="sort-option block w-full text-left px-4 py-3 font-mono text-xs uppercase text-gray-700 hover:bg-gray-100 transition-colors border-none cursor-pointer bg-transparent" data-sort="alpha-asc" role="menuitem">Alphabetically, A-Z</button>
          <button type="button" class="sort-option block w-full text-left px-4 py-3 font-mono text-xs uppercase text-gray-700 hover:bg-gray-100 transition-colors border-none cursor-pointer bg-transparent" data-sort="alpha-desc" role="menuitem">Alphabetically, Z-A</button>
          <button type="button" class="sort-option block w-full text-left px-4 py-3 font-mono text-xs uppercase text-gray-700 hover:bg-gray-100 transition-colors border-none cursor-pointer bg-transparent" data-sort="price-asc" role="menuitem">Price, low to high</button>
          <button type="button" class="sort-option block w-full text-left px-4 py-3 font-mono text-xs uppercase text-gray-700 hover:bg-gray-100 transition-colors border-none cursor-pointer bg-transparent" data-sort="price-desc" role="menuitem">Price, high to low</button>
          <button type="button" class="sort-option block w-full text-left px-4 py-3 font-mono text-xs uppercase text-gray-700 hover:bg-gray-100 transition-colors border-none cursor-pointer bg-transparent" data-sort="date-desc" role="menuitem">Date, old to new</button>
          <button type="button" class="sort-option block w-full text-left px-4 py-3 font-mono text-xs uppercase text-gray-700 hover:bg-gray-100 transition-colors border-none cursor-pointer bg-transparent" data-sort="date-asc" role="menuitem">Date, new to old</button>
        </div>
      </div>
    </div>

    <!-- Sidebar Filter Panel -->
    <aside 
      id="filter-panel-{{ section.id }}"
      class="filter-sidebar fixed top-0 left-0 h-full w-[400px] max-w-[90vw] bg-[#e8e6df] shadow-2xl transform -translate-x-full transition-transform duration-300 z-50 overflow-y-auto"
      data-filter-panel
      role="dialog"
      aria-modal="true"
      aria-label="Filter products">
      
      <!-- Sidebar Header -->
      <div class="sticky top-0 bg-[#e8e6df] border-b border-gray-400 px-6 py-4 flex justify-between items-center z-10">
        <h2 class="font-mono text-sm uppercase tracking-widest font-bold text-vinyl-black">FILTERS</h2>
        <button 
          class="filter-close w-8 h-8 flex items-center justify-center hover:bg-gray-300 transition-colors rounded-full bg-transparent border-none cursor-pointer"
          data-filter-close
          aria-label="Close filters">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M2 2L14 14M14 2L2 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <!-- Filter Sections -->
      <div class="px-6 py-4">
        
        <!-- Genre Filter -->
        <div class="filter-section border-b border-vinyl-blue pb-4 mb-4">
          <button 
            class="filter-section-toggle w-full flex justify-between items-center py-2 font-mono text-sm text-vinyl-blue hover:text-vinyl-black transition-colors bg-transparent border-none cursor-pointer text-left"
            data-filter-section="genre"
            aria-expanded="false">
            <span>Genre</span>
            <span class="filter-section-icon text-xl transition-transform">+</span>
          </button>
          <div class="filter-section-content hidden mt-2" data-filter-section-content="genre">
            <!-- Genre options would go here -->
            <label class="filter-option flex items-center gap-2 mb-2 cursor-pointer">
              <input type="checkbox" name="genre" value="rock" data-filter="genre" class="w-4 h-4 cursor-pointer">
              <span class="font-sans text-sm text-gray-700">Rock</span>
            </label>
          </div>
        </div>

        <!-- Label Filter -->
        <div class="filter-section border-b border-vinyl-blue pb-4 mb-4">
          <button 
            class="filter-section-toggle w-full flex justify-between items-center py-2 font-mono text-sm text-vinyl-blue hover:text-vinyl-black transition-colors bg-transparent border-none cursor-pointer text-left"
            data-filter-section="label"
            aria-expanded="false">
            <span>Label</span>
            <span class="filter-section-icon text-xl transition-transform">+</span>
          </button>
          <div class="filter-section-content hidden mt-2" data-filter-section-content="label">
            <!-- Label options would go here -->
          </div>
        </div>

        <!-- Manufacturer Filter -->
        <div class="filter-section border-b border-vinyl-blue pb-4 mb-4">
          <button 
            class="filter-section-toggle w-full flex justify-between items-center py-2 font-mono text-sm text-vinyl-blue hover:text-vinyl-black transition-colors bg-transparent border-none cursor-pointer text-left"
            data-filter-section="manufacturer"
            aria-expanded="false">
            <span>Manufacturer</span>
            <span class="filter-section-icon text-xl transition-transform">+</span>
          </button>
          <div class="filter-section-content hidden mt-2" data-filter-section-content="manufacturer">
            <!-- Manufacturer options would go here -->
          </div>
        </div>

        <!-- Format Filter -->
        <div class="filter-section border-b border-vinyl-blue pb-4 mb-4">
          <button 
            class="filter-section-toggle w-full flex justify-between items-center py-2 font-mono text-sm text-vinyl-blue hover:text-vinyl-black transition-colors bg-transparent border-none cursor-pointer text-left"
            data-filter-section="format"
            aria-expanded="false">
            <span>Format</span>
            <span class="filter-section-icon text-xl transition-transform">+</span>
          </button>
          <div class="filter-section-content hidden mt-2" data-filter-section-content="format">
            {%- assign product_types = '' | split: '' -%}
            {%- for product in collection.products -%}
              {%- unless product_types contains product.type -%}
                {%- assign product_types = product_types | push: product.type -%}
              {%- endunless -%}
            {%- endfor -%}
            
            {%- if product_types.size > 0 -%}
              {%- for product_type in product_types -%}
                <label class="filter-option flex items-center gap-2 mb-2 cursor-pointer">
                  <input type="checkbox" name="type" value="{{ product_type | handleize }}" data-filter="type" class="w-4 h-4 cursor-pointer">
                  <span class="font-sans text-sm text-gray-700">{{ product_type }}</span>
                </label>
              {%- endfor -%}
            {%- endif -%}
          </div>
        </div>

        <!-- Color Vinyl Filter -->
        <div class="filter-section border-b border-vinyl-blue pb-4 mb-4">
          <button 
            class="filter-section-toggle w-full flex justify-between items-center py-2 font-mono text-sm text-vinyl-blue hover:text-vinyl-black transition-colors bg-transparent border-none cursor-pointer text-left"
            data-filter-section="color"
            aria-expanded="false">
            <span>Color Vinyl</span>
            <span class="filter-section-icon text-xl transition-transform">+</span>
          </button>
          <div class="filter-section-content hidden mt-2" data-filter-section-content="color">
            <!-- Color vinyl options would go here -->
          </div>
        </div>

        <!-- Availability Filter -->
        <div class="filter-section border-b border-vinyl-blue pb-4 mb-4">
          <button 
            class="filter-section-toggle w-full flex justify-between items-center py-2 font-mono text-sm text-vinyl-blue hover:text-vinyl-black transition-colors bg-transparent border-none cursor-pointer text-left"
            data-filter-section="availability"
            aria-expanded="false">
            <span>Availability</span>
            <span class="filter-section-icon text-xl transition-transform">+</span>
          </button>
          <div class="filter-section-content hidden mt-2" data-filter-section-content="availability">
            <label class="filter-option flex items-center gap-2 mb-2 cursor-pointer">
              <input type="checkbox" name="availability" value="in-stock" data-filter="availability" class="w-4 h-4 cursor-pointer">
              <span class="font-sans text-sm text-gray-700">In stock</span>
            </label>
            <label class="filter-option flex items-center gap-2 cursor-pointer">
              <input type="checkbox" name="availability" value="sold-out" data-filter="availability" class="w-4 h-4 cursor-pointer">
              <span class="font-sans text-sm text-gray-700">Sold out</span>
            </label>
          </div>
        </div>

        <!-- Price Filter -->
        <div class="filter-section border-b border-vinyl-blue pb-4 mb-4">
          <button 
            class="filter-section-toggle w-full flex justify-between items-center py-2 font-mono text-sm text-vinyl-blue hover:text-vinyl-black transition-colors bg-transparent border-none cursor-pointer text-left"
            data-filter-section="price"
            aria-expanded="false">
            <span>Price</span>
            <span class="filter-section-icon text-xl transition-transform">+</span>
          </button>
          <div class="filter-section-content hidden mt-2" data-filter-section-content="price">
            <label class="filter-option flex items-center gap-2 mb-2 cursor-pointer">
              <input type="checkbox" name="price" value="0-25" data-filter="price" class="w-4 h-4 cursor-pointer">
              <span class="font-sans text-sm text-gray-700">Under $25</span>
            </label>
            <label class="filter-option flex items-center gap-2 mb-2 cursor-pointer">
              <input type="checkbox" name="price" value="25-50" data-filter="price" class="w-4 h-4 cursor-pointer">
              <span class="font-sans text-sm text-gray-700">$25 - $50</span>
            </label>
            <label class="filter-option flex items-center gap-2 mb-2 cursor-pointer">
              <input type="checkbox" name="price" value="50-100" data-filter="price" class="w-4 h-4 cursor-pointer">
              <span class="font-sans text-sm text-gray-700">$50 - $100</span>
            </label>
            <label class="filter-option flex items-center gap-2 cursor-pointer">
              <input type="checkbox" name="price" value="100+" data-filter="price" class="w-4 h-4 cursor-pointer">
              <span class="font-sans text-sm text-gray-700">Over $100</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Sidebar Footer -->
      <div class="sticky bottom-0 bg-[#e8e6df] border-t border-gray-400 px-6 py-4">
        <button 
          class="w-full py-3 px-6 border-2 border-vinyl-blue rounded-full font-mono text-xs uppercase tracking-widest text-vinyl-blue hover:bg-vinyl-blue hover:text-white transition-all bg-transparent cursor-pointer"
          data-view-items>
          VIEW <span data-product-count>{{ collection.products_count }}</span> ITEMS
        </button>
      </div>
    </aside>

    <!-- Product Grid (4 columns, separate from filter bar) -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 product-grid-container">
      {%- for product in collection.products limit: section.settings.products_to_show -%}
        <div class="product-grid-item border-r border-b border-vinyl-blue" 
             data-product-id="{{ product.id }}"
             data-price="{{ product.price | money_without_currency | remove: ',' | remove: ' ' }}"
             data-title="{{ product.title | downcase }}"
             data-type="{{ product.type | handleize }}"
             data-date="{{ product.created_at | date: '%s' }}"
             data-available="{{ product.available }}">
          {% render 'card-product', card_product: product %}
        </div>
      {%- else -%}
        {%- if request.page_type == 'collection' -%}
           <div class="col-span-full py-24 text-center font-mono text-sm uppercase text-gray-500">No products found</div>
        {%- else -%}
          {%- for i in (1..8) -%}
            <div class="product-grid-item border-r border-b border-vinyl-blue">
              {% render 'card-product' %}
            </div>
          {%- endfor -%}
        {%- endif -%}
      {%- endfor -%}
    </div>
  </div>

  {%- if section.settings.show_load_more -%}
    <div class="py-12 flex justify-center bg-vinyl-paper border-t border-vinyl-blue">
      <a href="{{ selected_collection.url }}" class="px-8 py-3 border border-vinyl-blue rounded-full text-vinyl-blue font-mono text-xs uppercase tracking-widest hover:bg-vinyl-blue hover:text-white transition-all no-underline">
        Load More
      </a>
    </div>
  {%- endif -%}
</div>

<script>
  class HomepageGrid_{{ section.id | replace: '-', '_' }} {
    constructor(container) {
      this.container = container;
      this.grid = container.querySelector('.product-grid-container');
      this.products = this.grid ? Array.from(this.grid.querySelectorAll('.product-grid-item')) : [];
      this.filterToggle = container.querySelector('[data-filter-toggle-isolated]');
      this.filterPanel = container.querySelector('[data-filter-panel]');
      this.backdrop = container.querySelector('[data-filter-backdrop]');
      this.sortToggle = container.querySelector('[data-sort-toggle]');
      this.sortMenu = container.querySelector('[data-sort-menu]');
      this.sortIcon = container.querySelector('[data-sort-icon]');
      this.sortOptions = container.querySelectorAll('[data-sort]');
      this.filters = container.querySelectorAll('[data-filter]');
      this.isOpen = false;
      
      this.activeFilters = {
        availability: [],
        price: [],
        type: []
      };
      
      this.init();
    }

    init() {
      // Filter toggle button
      this.filterToggle?.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        this.openSidebar();
      });
      
      // Close button
      this.container.querySelector('[data-filter-close]')?.addEventListener('click', (e) => {
        e.preventDefault();
        this.closeSidebar();
      });
      
      // Backdrop click to close
      this.backdrop?.addEventListener('click', () => this.closeSidebar());
      
      // View items button
      this.container.querySelector('[data-view-items]')?.addEventListener('click', () => this.closeSidebar());
      
      // Filter section toggles
      this.container.querySelectorAll('[data-filter-section]').forEach(toggle => {
        toggle.addEventListener('click', () => this.toggleFilterSection(toggle));
      });
      
      // Sort functionality
      this.sortToggle?.addEventListener('click', (e) => {
        e.stopPropagation();
        this.toggleSort();
      });
      
      this.sortOptions.forEach(option => {
        option.addEventListener('click', (e) => this.handleSort(e));
      });

      // Filter checkboxes
      this.filters.forEach(filter => {
        filter.addEventListener('change', (e) => this.handleFilter(e));
      });

      // Close sort menu when clicking outside
      document.addEventListener('click', (e) => {
        if (this.sortToggle?.getAttribute('aria-expanded') === 'true' && 
            !this.sortToggle.contains(e.target) && 
            !this.sortMenu?.contains(e.target)) {
          this.closeSortMenu();
        }
      });
    }

    openSidebar() {
      if (this.isOpen) return;
      this.isOpen = true;
      
      this.filterPanel?.classList.remove('-translate-x-full');
      this.filterPanel?.classList.add('translate-x-0');
      this.filterToggle?.setAttribute('aria-expanded', 'true');
      
      this.backdrop?.classList.remove('hidden', 'opacity-0', 'invisible');
      this.backdrop?.classList.add('opacity-100', 'visible');
      this.backdrop?.removeAttribute('aria-hidden');
      
      document.body.style.overflow = 'hidden';
    }

    closeSidebar() {
      if (!this.isOpen) return;
      this.isOpen = false;
      
      this.filterPanel?.classList.add('-translate-x-full');
      this.filterPanel?.classList.remove('translate-x-0');
      this.filterToggle?.setAttribute('aria-expanded', 'false');
      
      this.backdrop?.classList.add('opacity-0', 'invisible');
      this.backdrop?.classList.remove('opacity-100', 'visible');
      this.backdrop?.setAttribute('aria-hidden', 'true');
      
      setTimeout(() => {
        this.backdrop?.classList.add('hidden');
      }, 300);
      
      document.body.style.overflow = '';
    }

    toggleFilterSection(toggle) {
      const sectionName = toggle.getAttribute('data-filter-section');
      const content = this.container.querySelector(`[data-filter-section-content="${sectionName}"]`);
      const icon = toggle.querySelector('.filter-section-icon');
      const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
      
      if (isExpanded) {
        // Collapse
        content.classList.add('hidden');
        toggle.setAttribute('aria-expanded', 'false');
        icon.textContent = '+';
      } else {
        // Expand
        content.classList.remove('hidden');
        toggle.setAttribute('aria-expanded', 'true');
        icon.textContent = 'âˆ’';
      }
    }

    toggleSort() {
      if (!this.sortToggle) return;
      
      const isExpanded = this.sortToggle.getAttribute('aria-expanded') === 'true';
      
      if (isExpanded) {
        this.closeSortMenu();
      } else {
        if (this.sortMenu) {
          this.sortMenu.style.opacity = '1';
          this.sortMenu.style.visibility = 'visible';
          this.sortMenu.style.transform = 'translateY(0)';
        }
        this.sortToggle.setAttribute('aria-expanded', 'true');
        if (this.sortIcon) {
          this.sortIcon.style.transform = 'rotate(180deg)';
        }
      }
    }

    closeSortMenu() {
      if (this.sortMenu) {
        this.sortMenu.style.opacity = '0';
        this.sortMenu.style.visibility = 'hidden';
        this.sortMenu.style.transform = 'translateY(-10px)';
      }
      if (this.sortToggle) {
        this.sortToggle.setAttribute('aria-expanded', 'false');
      }
      if (this.sortIcon) {
        this.sortIcon.style.transform = 'rotate(0deg)';
      }
    }

    handleSort(e) {
      const sortType = e.target.dataset.sort;
      
      // Update active state
      this.sortOptions.forEach(opt => {
        opt.classList.remove('text-vinyl-blue');
        opt.classList.add('text-gray-700');
      });
      e.target.classList.add('text-vinyl-blue');
      e.target.classList.remove('text-gray-700');
      
      this.sortProducts(sortType);
      this.closeSortMenu();
    }

    sortProducts(sortType) {
      let sortedProducts = [...this.products];

      switch(sortType) {
        case 'alpha-asc':
          sortedProducts.sort((a, b) => 
            a.dataset.title.localeCompare(b.dataset.title));
          break;
        case 'alpha-desc':
          sortedProducts.sort((a, b) => 
            b.dataset.title.localeCompare(a.dataset.title));
          break;
        case 'price-asc':
          sortedProducts.sort((a, b) => 
            parseFloat(a.dataset.price) - parseFloat(b.dataset.price));
          break;
        case 'price-desc':
          sortedProducts.sort((a, b) => 
            parseFloat(b.dataset.price) - parseFloat(a.dataset.price));
          break;
        case 'date-asc':
          sortedProducts.sort((a, b) => 
            parseInt(a.dataset.date) - parseInt(b.dataset.date));
          break;
        case 'date-desc':
          sortedProducts.sort((a, b) => 
            parseInt(b.dataset.date) - parseInt(a.dataset.date));
          break;
      }

      if (this.grid) {
        sortedProducts.forEach(product => this.grid.appendChild(product));
      }
    }

    handleFilter(e) {
      const filterType = e.target.name;
      const filterValue = e.target.value;
      
      if (e.target.checked) {
        this.activeFilters[filterType].push(filterValue);
      } else {
        this.activeFilters[filterType] = this.activeFilters[filterType]
          .filter(v => v !== filterValue);
      }
      
      this.filterProducts();
    }

    filterProducts() {
      this.products.forEach(product => {
        let show = true;

        // Availability filter
        if (this.activeFilters.availability.length > 0) {
          const available = product.dataset.available === 'true';
          const matchesAvailability = this.activeFilters.availability.some(filter => {
            if (filter === 'in-stock') return available;
            if (filter === 'sold-out') return !available;
            return false;
          });
          if (!matchesAvailability) show = false;
        }

        // Price filter
        if (this.activeFilters.price.length > 0) {
          const price = parseFloat(product.dataset.price);
          const matchesPrice = this.activeFilters.price.some(filter => {
            if (filter === '0-25') return price < 25;
            if (filter === '25-50') return price >= 25 && price < 50;
            if (filter === '50-100') return price >= 50 && price < 100;
            if (filter === '100+') return price >= 100;
            return false;
          });
          if (!matchesPrice) show = false;
        }

        // Type filter
        if (this.activeFilters.type.length > 0) {
          const matchesType = this.activeFilters.type.includes(product.dataset.type);
          if (!matchesType) show = false;
        }

        product.style.display = show ? '' : 'none';
      });
    }
  }

  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      const section = document.querySelector('#homepage-grid-{{ section.id }}');
      if (section && !section.dataset.initialized) {
        new HomepageGrid_{{ section.id | replace: '-', '_' }}(section);
        section.dataset.initialized = 'true';
      }
    });
  } else {
    const section = document.querySelector('#homepage-grid-{{ section.id }}');
    if (section && !section.dataset.initialized) {
      new HomepageGrid_{{ section.id | replace: '-', '_' }}(section);
      section.dataset.initialized = 'true';
    }
  }
</script>

{% schema %}
{
  "name": "Homepage Grid",
  "tag": "section",
  "class": "section-homepage-grid",
  "settings": [
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 4,
      "max": 48,
      "step": 4,
      "default": 16,
      "label": "Products to show"
    },
    {
      "type": "checkbox",
      "id": "show_load_more",
      "default": true,
      "label": "Show \"Load More\" button"
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "presets": [
    {
      "name": "Homepage Grid",
      "settings": {
        "products_to_show": 16,
        "show_load_more": true
      }
    }
  ]
}
{% endschema %}
