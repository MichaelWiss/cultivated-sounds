{%- liquid
  assign selected_collection = section.settings.collection | default: collections['all']
  if request.page_type == 'collection'
    assign collection = collection
  else
    assign collection = selected_collection
  endif
-%}

<div class="homepage-grid-section relative border-b border-vinyl-blue" id="homepage-grid-{{ section.id }}">
  
  <!-- Product Grid with integrated filter bar -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 border-l border-vinyl-blue product-grid-container">
    
    <!-- Filter Bar as First Grid Row -->
    <div class="col-span-full bg-vinyl-blue border-r border-b border-vinyl-blue py-4 px-4 sm:px-8 flex justify-between items-center" data-filter-bar>
      <!-- Filters Button (Left) -->
      <button 
        class="filter-toggle flex items-center gap-2 font-mono text-xs uppercase font-bold text-white hover:text-gray-200 transition-colors no-underline bg-transparent border-none cursor-pointer"
        data-filter-toggle
        aria-expanded="false"
        aria-controls="filter-panel-{{ section.id }}">
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" class="transition-transform" data-filter-icon>
          <path d="M3 6l3 3 3-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
        FILTERS
      </button>

      <!-- Sort Dropdown (Right) -->
      <div class="sort-dropdown relative" data-sort-dropdown>
        <button 
          class="sort-toggle flex items-center gap-2 font-mono text-xs uppercase font-bold text-white hover:text-gray-200 transition-colors bg-transparent border-none cursor-pointer"
          data-sort-toggle
          aria-expanded="false"
          aria-controls="sort-menu-{{ section.id }}">
          SORT BY
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none" class="transition-transform" data-sort-icon>
            <path d="M3 5l3 3 3-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </button>
        
        <!-- Sort Menu -->
        <div 
          id="sort-menu-{{ section.id }}"
          class="sort-menu absolute top-full right-0 mt-2 bg-white border border-gray-300 min-w-[220px] opacity-0 invisible translate-y-[-10px] transition-all duration-200 shadow-lg z-50"
          data-sort-menu
          role="menu">
          <button class="sort-option block w-full text-left px-4 py-3 font-mono text-xs uppercase text-vinyl-blue hover:bg-gray-100 transition-colors border-none cursor-pointer bg-transparent" data-sort="featured" role="menuitem">Featured</button>
          <button class="sort-option block w-full text-left px-4 py-3 font-mono text-xs uppercase text-gray-700 hover:bg-gray-100 transition-colors border-none cursor-pointer bg-transparent" data-sort="best-selling" role="menuitem">Best selling</button>
          <button class="sort-option block w-full text-left px-4 py-3 font-mono text-xs uppercase text-gray-700 hover:bg-gray-100 transition-colors border-none cursor-pointer bg-transparent" data-sort="alpha-asc" role="menuitem">Alphabetically, A-Z</button>
          <button class="sort-option block w-full text-left px-4 py-3 font-mono text-xs uppercase text-gray-700 hover:bg-gray-100 transition-colors border-none cursor-pointer bg-transparent" data-sort="alpha-desc" role="menuitem">Alphabetically, Z-A</button>
          <button class="sort-option block w-full text-left px-4 py-3 font-mono text-xs uppercase text-gray-700 hover:bg-gray-100 transition-colors border-none cursor-pointer bg-transparent" data-sort="price-asc" role="menuitem">Price, low to high</button>
          <button class="sort-option block w-full text-left px-4 py-3 font-mono text-xs uppercase text-gray-700 hover:bg-gray-100 transition-colors border-none cursor-pointer bg-transparent" data-sort="price-desc" role="menuitem">Price, high to low</button>
          <button class="sort-option block w-full text-left px-4 py-3 font-mono text-xs uppercase text-gray-700 hover:bg-gray-100 transition-colors border-none cursor-pointer bg-transparent" data-sort="date-desc" role="menuitem">Date, old to new</button>
          <button class="sort-option block w-full text-left px-4 py-3 font-mono text-xs uppercase text-gray-700 hover:bg-gray-100 transition-colors border-none cursor-pointer bg-transparent" data-sort="date-asc" role="menuitem">Date, new to old</button>
        </div>
      </div>
    </div>

    <!-- Expandable Filter Panel -->
    <div 
      id="filter-panel-{{ section.id }}"
      class="col-span-full filter-panel bg-gray-100 border-r border-b border-gray-300 overflow-hidden max-h-0 opacity-0 transition-all duration-300"
      data-filter-panel
      role="region"
      aria-hidden="true">
      <div class="px-4 sm:px-8 py-6 grid grid-cols-1 sm:grid-cols-3 gap-6">
        
        <!-- Availability Filter -->
        <div class="filter-group">
          <h3 class="font-mono text-xs uppercase font-bold text-vinyl-black mb-3">Availability</h3>
          <label class="filter-option flex items-center gap-2 mb-2 cursor-pointer">
            <input type="checkbox" name="availability" value="in-stock" data-filter="availability" class="w-4 h-4 cursor-pointer">
            <span class="font-sans text-sm text-gray-700">In stock</span>
          </label>
          <label class="filter-option flex items-center gap-2 cursor-pointer">
            <input type="checkbox" name="availability" value="sold-out" data-filter="availability" class="w-4 h-4 cursor-pointer">
            <span class="font-sans text-sm text-gray-700">Sold out</span>
          </label>
        </div>

        <!-- Price Filter -->
        <div class="filter-group">
          <h3 class="font-mono text-xs uppercase font-bold text-vinyl-black mb-3">Price</h3>
          <label class="filter-option flex items-center gap-2 mb-2 cursor-pointer">
            <input type="checkbox" name="price" value="0-25" data-filter="price" class="w-4 h-4 cursor-pointer">
            <span class="font-sans text-sm text-gray-700">Under $25</span>
          </label>
          <label class="filter-option flex items-center gap-2 mb-2 cursor-pointer">
            <input type="checkbox" name="price" value="25-50" data-filter="price" class="w-4 h-4 cursor-pointer">
            <span class="font-sans text-sm text-gray-700">$25 - $50</span>
          </label>
          <label class="filter-option flex items-center gap-2 mb-2 cursor-pointer">
            <input type="checkbox" name="price" value="50-100" data-filter="price" class="w-4 h-4 cursor-pointer">
            <span class="font-sans text-sm text-gray-700">$50 - $100</span>
          </label>
          <label class="filter-option flex items-center gap-2 cursor-pointer">
            <input type="checkbox" name="price" value="100+" data-filter="price" class="w-4 h-4 cursor-pointer">
            <span class="font-sans text-sm text-gray-700">Over $100</span>
          </label>
        </div>

        <!-- Product Type Filter -->
        <div class="filter-group">
          <h3 class="font-mono text-xs uppercase font-bold text-vinyl-black mb-3">Product type</h3>
          {%- assign product_types = '' | split: '' -%}
          {%- for product in collection.products -%}
            {%- unless product_types contains product.type -%}
              {%- assign product_types = product_types | push: product.type -%}
            {%- endunless -%}
          {%- endfor -%}
          
          {%- if product_types.size > 0 -%}
            {%- for product_type in product_types -%}
              <label class="filter-option flex items-center gap-2 mb-2 cursor-pointer">
                <input type="checkbox" name="type" value="{{ product_type | handleize }}" data-filter="type" class="w-4 h-4 cursor-pointer">
                <span class="font-sans text-sm text-gray-700">{{ product_type }}</span>
              </label>
            {%- endfor -%}
          {%- else -%}
            <label class="filter-option flex items-center gap-2 mb-2 cursor-pointer">
              <input type="checkbox" name="type" value="vinyl" data-filter="type" class="w-4 h-4 cursor-pointer">
              <span class="font-sans text-sm text-gray-700">Vinyl</span>
            </label>
          {%- endif -%}
        </div>
      </div>
    </div>

    <!-- Product Cards -->
    {%- for product in collection.products limit: section.settings.products_to_show -%}
      <div class="product-grid-item border-r border-b border-vinyl-blue" 
           data-product-id="{{ product.id }}"
           data-price="{{ product.price | money_without_currency | remove: ',' | remove: ' ' }}"
           data-title="{{ product.title | downcase }}"
           data-type="{{ product.type | handleize }}"
           data-date="{{ product.created_at | date: '%s' }}"
           data-available="{{ product.available }}">
        {% render 'card-product', card_product: product %}
      </div>
    {%- else -%}
      {%- if request.page_type == 'collection' -%}
         <div class="col-span-full py-24 text-center font-mono text-sm uppercase text-gray-500">No products found</div>
      {%- else -%}
        {%- for i in (1..8) -%}
          <div class="product-grid-item border-r border-b border-vinyl-blue">
            {% render 'card-product' %}
          </div>
        {%- endfor -%}
      {%- endif -%}
    {%- endfor -%}
  </div>

  {%- if section.settings.show_load_more -%}
    <div class="py-12 flex justify-center bg-vinyl-paper border-t border-vinyl-blue">
      <a href="{{ selected_collection.url }}" class="px-8 py-3 border border-vinyl-blue rounded-full text-vinyl-blue font-mono text-xs uppercase tracking-widest hover:bg-vinyl-blue hover:text-white transition-all no-underline">
        Load More
      </a>
    </div>
  {%- endif -%}
</div>

<script>
  class HomepageGrid {
    constructor(container) {
      this.container = container;
      this.grid = container.querySelector('.product-grid-container');
      this.products = Array.from(this.grid.querySelectorAll('.product-grid-item'));
      this.filterToggle = container.querySelector('[data-filter-toggle]');
      this.filterPanel = container.querySelector('[data-filter-panel]');
      this.filterIcon = container.querySelector('[data-filter-icon]');
      this.sortToggle = container.querySelector('[data-sort-toggle]');
      this.sortMenu = container.querySelector('[data-sort-menu]');
      this.sortIcon = container.querySelector('[data-sort-icon]');
      this.sortOptions = container.querySelectorAll('[data-sort]');
      this.filters = container.querySelectorAll('[data-filter]');
      
      this.activeFilters = {
        availability: [],
        price: [],
        type: []
      };
      
      this.init();
    }

    init() {
      // Filter toggle
      this.filterToggle?.addEventListener('click', () => this.toggleFilters());
      
      // Sort toggle
      this.sortToggle?.addEventListener('click', (e) => {
        e.stopPropagation();
        this.toggleSort();
      });
      
      // Sort options
      this.sortOptions.forEach(option => {
        option.addEventListener('click', (e) => this.handleSort(e));
      });

      // Filter checkboxes
      this.filters.forEach(filter => {
        filter.addEventListener('change', (e) => this.handleFilter(e));
      });

      // Close sort menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('[data-sort-dropdown]')) {
          this.closeSortMenu();
        }
      });
    }

    toggleFilters() {
      const isExpanded = this.filterToggle.getAttribute('aria-expanded') === 'true';
      
      if (isExpanded) {
        // Close
        this.filterPanel.style.maxHeight = '0';
        this.filterPanel.style.opacity = '0';
        this.filterPanel.setAttribute('aria-hidden', 'true');
        this.filterToggle.setAttribute('aria-expanded', 'false');
        this.filterIcon.style.transform = 'rotate(0deg)';
      } else {
        // Open
        this.filterPanel.style.maxHeight = '500px';
        this.filterPanel.style.opacity = '1';
        this.filterPanel.setAttribute('aria-hidden', 'false');
        this.filterToggle.setAttribute('aria-expanded', 'true');
        this.filterIcon.style.transform = 'rotate(180deg)';
      }
    }

    toggleSort() {
      const isExpanded = this.sortToggle.getAttribute('aria-expanded') === 'true';
      
      if (isExpanded) {
        this.closeSortMenu();
      } else {
        this.sortMenu.style.opacity = '1';
        this.sortMenu.style.visibility = 'visible';
        this.sortMenu.style.transform = 'translateY(0)';
        this.sortToggle.setAttribute('aria-expanded', 'true');
        this.sortIcon.style.transform = 'rotate(180deg)';
      }
    }

    closeSortMenu() {
      this.sortMenu.style.opacity = '0';
      this.sortMenu.style.visibility = 'hidden';
      this.sortMenu.style.transform = 'translateY(-10px)';
      this.sortToggle.setAttribute('aria-expanded', 'false');
      this.sortIcon.style.transform = 'rotate(0deg)';
    }

    handleSort(e) {
      const sortType = e.target.dataset.sort;
      
      // Update active state
      this.sortOptions.forEach(opt => {
        opt.classList.remove('text-vinyl-blue');
        opt.classList.add('text-gray-700');
      });
      e.target.classList.add('text-vinyl-blue');
      e.target.classList.remove('text-gray-700');
      
      this.sortProducts(sortType);
      this.closeSortMenu();
    }

    sortProducts(sortType) {
      let sortedProducts = [...this.products];

      switch(sortType) {
        case 'alpha-asc':
          sortedProducts.sort((a, b) => 
            a.dataset.title.localeCompare(b.dataset.title));
          break;
        case 'alpha-desc':
          sortedProducts.sort((a, b) => 
            b.dataset.title.localeCompare(a.dataset.title));
          break;
        case 'price-asc':
          sortedProducts.sort((a, b) => 
            parseFloat(a.dataset.price) - parseFloat(b.dataset.price));
          break;
        case 'price-desc':
          sortedProducts.sort((a, b) => 
            parseFloat(b.dataset.price) - parseFloat(a.dataset.price));
          break;
        case 'date-asc':
          sortedProducts.sort((a, b) => 
            parseInt(a.dataset.date) - parseInt(b.dataset.date));
          break;
        case 'date-desc':
          sortedProducts.sort((a, b) => 
            parseInt(b.dataset.date) - parseInt(a.dataset.date));
          break;
      }

      sortedProducts.forEach(product => this.grid.appendChild(product));
    }

    handleFilter(e) {
      const filterType = e.target.name;
      const filterValue = e.target.value;
      
      if (e.target.checked) {
        this.activeFilters[filterType].push(filterValue);
      } else {
        this.activeFilters[filterType] = this.activeFilters[filterType]
          .filter(v => v !== filterValue);
      }
      
      this.filterProducts();
    }

    filterProducts() {
      this.products.forEach(product => {
        let show = true;

        // Availability filter
        if (this.activeFilters.availability.length > 0) {
          const available = product.dataset.available === 'true';
          const matchesAvailability = this.activeFilters.availability.some(filter => {
            if (filter === 'in-stock') return available;
            if (filter === 'sold-out') return !available;
            return false;
          });
          if (!matchesAvailability) show = false;
        }

        // Price filter
        if (this.activeFilters.price.length > 0) {
          const price = parseFloat(product.dataset.price);
          const matchesPrice = this.activeFilters.price.some(filter => {
            if (filter === '0-25') return price < 25;
            if (filter === '25-50') return price >= 25 && price < 50;
            if (filter === '50-100') return price >= 50 && price < 100;
            if (filter === '100+') return price >= 100;
            return false;
          });
          if (!matchesPrice) show = false;
        }

        // Type filter
        if (this.activeFilters.type.length > 0) {
          const matchesType = this.activeFilters.type.includes(product.dataset.type);
          if (!matchesType) show = false;
        }

        product.style.display = show ? '' : 'none';
      });
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const section = document.querySelector('#homepage-grid-{{ section.id }}');
    if (section) {
      new HomepageGrid(section);
    }
  });
</script>

{% schema %}
{
  "name": "Homepage Grid",
  "tag": "section",
  "class": "section-homepage-grid",
  "settings": [
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 4,
      "max": 48,
      "step": 4,
      "default": 16,
      "label": "Products to show"
    },
    {
      "type": "checkbox",
      "id": "show_load_more",
      "default": true,
      "label": "Show \"Load More\" button"
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "presets": [
    {
      "name": "Homepage Grid",
      "settings": {
        "products_to_show": 16,
        "show_load_more": true
      }
    }
  ]
}
{% endschema %}
